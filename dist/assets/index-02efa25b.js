var Yt=Object.defineProperty;var Jt=(a,e,t)=>e in a?Yt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var y=(a,e,t)=>(Jt(a,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class qt{constructor(){this.toLoad={hero:"/sprites/hero-sheet.png",caveGround:"/sprites/cave-ground.png",shadow:"/sprites/shadow.png",exit:"/sprites/exit.png",rod:"/sprites/rod.png",ground:"/sprites/ground.png",fontWhite:"/sprites/sprite-font-white-3.png",textBox:"/sprites/text-box.png",userInputBox:"/sprites/user-input-box.png",sky:"/sprites/sky.png",cave:"/sprites/cave.png",portraits:"/sprites/portraits-sheet.png",knight:"/sprites/knight-sheet-1.png",shopBackground:"/sprites/shop-background.png",shopFloor:"sprites/shop-assets/Room_Builder_free_16x16.png",shopObjects:"sprites/shop-assets/Interiors_free_16x16.png",vase:"sprites/shop-assets/Vase_16x16.png",picture:"sprites/shop-assets/Picture_16x16.png",television:"sprites/shop-assets/TV_16x16.png",bookshelf:"sprites/shop-assets/Bookshelf_16x16.png"},this.images={},Object.keys(this.toLoad).forEach(e=>{const t=new Image;t.src=this.toLoad[e],this.images[e]={image:t,isLoaded:!1},t.onload=()=>{this.images[e].isLoaded=!0}})}}const u=new qt,K="LEFT",V="RIGHT",M="UP",D="DOWN";class Se{constructor(e=""){this.heldDirections=[],this.keys={},this.lastKeys={},this.lastTextKeys=[],document.addEventListener("keydown",t=>{t.key==="Escape"&&t.preventDefault(),this.keys[t.code]=!0,e.indexOf(t.key)>-1&&this.lastTextKeys.push(t.key),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowPressed(K),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowPressed(V),(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowPressed(M),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowPressed(D)}),document.addEventListener("keyup",t=>{this.keys[t.code]=!1,(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowReleased(K),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowReleased(V),(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowReleased(M),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowReleased(D)})}get direction(){return this.heldDirections[0]}update(){this.lastKeys={...this.keys}}clearKeyboardText(){this.lastTextKeys=[]}getKeyboardText(){const e=this.lastTextKeys.join("");return this.clearKeyboardText(),e}getActionJustPressed(e){let t=!1;return this.keys[e]&&!this.lastKeys[e]&&(t=!0),t}onArrowPressed(e){this.heldDirections.indexOf(e)===-1&&this.heldDirections.unshift(e)}onArrowReleased(e){const t=this.heldDirections.indexOf(e);t!==-1&&this.heldDirections.splice(t,1)}}class r{constructor(e=0,t=0){this.x=e,this.y=t}duplicate(){return new r(this.x,this.y)}matches(e){return this.x===e.x&&this.y===e.y}toNeighbor(e){let t=this.x,s=this.y;return e===K&&(t-=16),e===V&&(t+=16),e===M&&(s-=16),e===D&&(s+=16),new r(t,s)}toStepNeighbor(e){let t=this.x,s=this.y;return e===K&&t--,e===V&&t++,e===M&&s--,e===D&&s++,new r(t,s)}}class $t{constructor(){y(this,"callbacks",[]);y(this,"nextId",0)}emit(e,t){this.callbacks.forEach(s=>{s.eventName===e&&s.callback(t)})}on(e,t,s){return this.nextId+=1,this.callbacks.push({id:this.nextId,eventName:e,caller:t,callback:s}),this.nextId}off(e){this.callbacks=this.callbacks.filter(t=>t.id!==e)}unsubscribe(e){this.callbacks=this.callbacks.filter(t=>t.caller!==e)}}const c=new $t;class _{constructor({position:e}){this.position=e??new r(0,0),this.children=[],this.parent=null,this.hasReadyBeenCalled=!1,this.isSolid=!1,this.drawLayer=null}stepEntry(e,t){this.children.forEach(s=>{try{s.stepEntry(e,t)}catch{}}),this.hasReadyBeenCalled||(this.hasReadyBeenCalled=!0,this.ready()),this.step(e,t)}ready(){}step(e){}draw(e,t,s){const i=t+this.position.x,n=s+this.position.y;this.drawImage(e,i,n),this.getDrawChildrenOrdered().forEach(o=>{try{o.draw(e,i,n)}catch{}})}getDrawChildrenOrdered(){return[...this.children].sort((e,t)=>e.drawLayer==="FLOOR"?-1:e.position.y>t.position.y?1:-1)}drawImage(e,t,s){}destroy(){this.children.forEach(e=>{e.destroy()}),this.parent.removeChild(this)}addChild(e){e.parent=this,this.children.push(e)}hasChild(e){return this.children.findIndex(t=>t===e)>-1}removeChild(e){c.unsubscribe(e),this.children=this.children.filter(t=>e!==t)}}class f extends _{constructor({resource:e,frameSize:t,hFrames:s,vFrames:i,frame:n,scale:o,position:h,animations:p}){super({}),this.resource=e,this.frameSize=t??new r(16,16),this.hFrames=s??1,this.vFrames=i??1,this.frame=n??0,this.frameMap=new Map,this.scale=o??1,this.position=h??new r(0,0),this.animations=p??null,this.buildFrameMap()}buildFrameMap(){let e=0;for(let t=0;t<this.vFrames;t++)for(let s=0;s<this.hFrames;s++)this.frameMap.set(e,new r(s*this.frameSize.x,t*this.frameSize.y)),e++}step(e){this.animations&&(this.animations.step(e),this.frame=this.animations.frame)}drawImage(e,t,s){if(!this.resource.isLoaded)return;let i=0,n=0;const o=this.frameMap.get(this.frame);o&&(i=o.x,n=o.y);const h=this.frameSize.x,p=this.frameSize.y;e.drawImage(this.resource.image,i,n,h,p,t,s,h*this.scale,p*this.scale)}}class Qt{constructor(e,t){this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=e,this.render=t,this.rafId=null,this.isRunning=!1}mainLoop(e){if(!this.isRunning)return;let t=e-this.lastFrameTime;for(this.lastFrameTime=e,this.accumulatedTime+=t;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(s=>{this.mainLoop(s)})}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(e=>{this.mainLoop(e)}))}stop(){this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1}}const Zt=16;function d(a){return a*Zt}function es(a,e,t){const s=`${e}, ${t}`;return!a.has(s)}function ts(a,e,t){let s=e.x-a.position.x,i=e.y-a.position.y,n=Math.sqrt(s**2+i**2);if(n<=t)a.position.x=e.x,a.position.y=e.y;else{let o=s/n,h=i/n;a.position.x+=o*t,a.position.y+=h*t,n=Math.sqrt(s**2+i**2)}return n}class Ne extends _{constructor(){super({}),this.background=null,this.foreground=null}}class St{constructor(e){this.patterns=e,this.activeKey=Object.keys(this.patterns)[0]}get frame(){return this.patterns[this.activeKey].frame}play(e,t=0){this.activeKey!==e&&(this.activeKey=e,this.step(t))}step(e){this.patterns[this.activeKey].step(e)}}class F{constructor(e){this.currentTime=0,this.animationConfig=e,this.duration=e.duration??500}get frame(){const e=this.animationConfig.frames;for(let t=e.length-1;t>=0;t--)if(this.currentTime>=e[t].time)return e[t].frame;throw"Time is before the first keyframe"}step(e){this.currentTime+=e,this.currentTime>=this.duration&&(this.currentTime=0)}}function _e(a=0){return{duration:400,frames:[{time:0,frame:a+1},{time:100,frame:a},{time:200,frame:a+1},{time:300,frame:a+2}]}}function ye(a=0){return{duration:400,frames:[{time:0,frame:a}]}}const ss=_e(0),is=_e(3),ns=_e(6),os=_e(9),rs=ye(1),as=ye(4),hs=ye(7),ds=ye(10),cs={duration:400,frames:[{time:0,frame:12}]},ls=new St({WALK_DOWN:new F(ss),WALK_RIGHT:new F(is),WALK_UP:new F(ns),WALK_LEFT:new F(os),STAND_DOWN:new F(rs),STAND_RIGHT:new F(as),STAND_UP:new F(hs),STAND_LEFT:new F(ds),PICK_UP_DOWN:new F(cs)});class Oe extends _{constructor(e,t){super({position:new r(e,t)}),this.body=new f({resource:u.images.hero,frameSize:new r(32,32),hFrames:3,vFrames:8,frame:1,position:new r(-8,-20),animations:ls}),this.destinationPosition=this.position.duplicate(),this.facingDirection=D,this.itemPickupTime=0,this.itemPickupShell=null,this.isLocked=!1;const s=new f({resource:u.images.shadow,position:new r(-8,-19),frameSize:new r(32,32)});this.addChild(s),this.addChild(this.body)}ready(){c.on("HERO_PICKS_UP_ITEM",this,e=>{this.onPickUpItem(e)}),c.on("START_TEXT_BOX",this,e=>{this.lockHero(e)}),c.on("START_TEXT_INPUT",this,e=>{this.lockHero(e)}),c.on("END_TEXT_BOX",this,e=>{this.unlockHero(e)}),c.on("DECIDE_INPUT_TEXT",this,e=>{this.unlockHero(e)}),c.on("CANCEL_INPUT_TEXT",this,e=>{this.unlockHero(e)})}lockHero(e){this.isLocked=!0}unlockHero(e){this.isLocked=!1}step(e,t){if(this.isLocked)return;if(this.itemPickupTime>0){this.workOnItemPickup(e);return}const s=t.input;if(s!=null&&s.getActionJustPressed("Space")){const o=this.parent.children.find(h=>h.position.matches(this.position.toNeighbor(this.facingDirection)));o&&c.emit("HERO_REQUESTS_ACTION",o)}ts(this,this.destinationPosition,1)<=1&&this.tryMove(t),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,c.emit("HERO_POSITION",this.position))}tryMove(e){var h;const t=e.input;if(!t.direction){this.facingDirection===K&&this.body.animations.play("STAND_LEFT"),this.facingDirection===V&&this.body.animations.play("STAND_RIGHT"),this.facingDirection===M&&this.body.animations.play("STAND_UP"),this.facingDirection===D&&this.body.animations.play("STAND_DOWN");return}let s=this.destinationPosition.x,i=this.destinationPosition.y;t.direction===K&&(s-=d(1),this.body.frame=9,this.body.animations.play("WALK_LEFT"),this.facingDirection=K),t.direction===V&&(s+=d(1),this.body.frame=3,this.body.animations.play("WALK_RIGHT"),this.facingDirection=V),t.direction===M&&(i-=d(1),this.body.frame=6,this.body.animations.play("WALK_UP"),this.facingDirection=M),t.direction===D&&(i+=d(1),this.body.frame=0,this.body.animations.play("WALK_DOWN"),this.facingDirection=D);const n=es((h=e.level)==null?void 0:h.walls,s,i),o=this.parent.children.find(p=>p.isSolid&&p.position.x===s&&p.position.y===i);n&&!o&&(this.destinationPosition.x=s,this.destinationPosition.y=i)}onPickUpItem(e){const t=e.image,s=e.position;this.destinationPosition=s.duplicate(),this.itemPickupTime=2500,this.itemPickupShell=new _({}),this.itemPickupShell.addChild(new f({resource:t,position:new r(0,-18)})),this.addChild(this.itemPickupShell)}workOnItemPickup(e){this.itemPickupTime-=e,this.body.animations.play("PICK_UP_DOWN"),this.itemPickupTime<=0&&this.itemPickupShell.destroy()}}class Ge extends _{constructor(e,t){super({position:new r(e,t)});const s=new f({resource:u.images.rod,position:new r(0,-5)});this.addChild(s)}ready(){c.on("HERO_POSITION",this,e=>{const t=Math.round(e.x),s=Math.round(e.y);t===this.position.x&&s===this.position.y&&this.onCollideWithHero()})}onCollideWithHero(){this.destroy(),console.log("HERO_PICKS_UP_ITEM"),c.emit("HERO_PICKS_UP_ITEM",{image:u.images.rod,position:this.position})}}class X extends _{constructor(e,t){super({position:new r(e,t)});const s=new f({resource:u.images.exit,position:new r(0,0)});this.addChild(s),this.drawLayer="FLOOR"}ready(){c.on("HERO_POSITION",this,e=>{const t=Math.round(e.x),s=Math.round(e.y);t===this.position.x&&s===this.position.y&&this.enteredSpace()})}enteredSpace(){c.emit("HERO_EXIT",{position:this.position})}}class Ts{constructor(){this.flags=new Map}add(e){this.flags.set(e,!0)}remove(e){this.flags.remove(e)}getRelevantScenario(e=[]){return e.find(t=>{const s=t.bypass??[];for(let n=0;n<s.length;n++){const o=s[n];if(this.flags.has(o))return!1}const i=t.requires??[];for(let n=0;n<i.length;n++){const o=i[n];if(!this.flags.has(o))return!1}return!0})}}const Re="TALKED_TO_A",Tt="TALKED_TO_B",Xe=new Ts;class pt extends _{constructor(e,t,s){super({position:new r(e,t)}),this.isSolid=!0,this.content=s.content,this.portraitFrame=s.portraitFrame;const i=new f({resource:u.images.shadow,frameSize:new r(32,32),position:new r(-8,-19)});this.addChild(i);const n=new f({resource:u.images.knight,frameSize:new r(32,32),hFrames:2,vFrames:1,position:new r(-8,-20)});this.addChild(n)}getContent(){const e=Xe.getRelevantScenario(this.content);return e?{portraitFrame:this.portraitFrame,string:e.string,addFlags:e.addsFlag??null}:(console.warn("No matches found in this list!",this.content),null)}}const k="NORTH_SINGLE",B="NORTH_RIGHT",R="NORTH",G="NORTH_LEFT",Ke="NORTH_WEST_CORNER",Pe="NORTH_WEST",fe="WEST_TOP",Ve="WEST",ze="WEST_BOTTOM",je="SOUTH_WEST",Ye="SOUTH_WEST_CORNER",Je="SOUTH_LEFT",qe="SOUTH",$e="SOUTH_RIGHT",Qe="SOUTH_EAST",Ze="SOUTH_EAST_CORNER",et="EAST_BOTTOM",tt="EAST",me="EAST_TOP",ve="NORTH_EAST",st="NORTH_EAST_CORNER",v="CENTER",L="CENTER_NORTH_WEST_CORNER",C="CENTER_NORTH",U="CENTER_NORTH_WEST",A="CENTER_WEST",ps=[k,B,R,G,Ke,Pe,fe,Ve,ze,je,Ye,Je,qe,$e,Qe,Ze,et,tt,me,ve,st,v,L,U,A,C],ut=-1,Nt=0;class T{constructor(e={}){this.matrix=e,this._width=this.calculateWidth(),this._height=this.calculateHeight()}add(e,t,s){this.matrix[t]||(this.matrix[t]={}),this.matrix[t][e]=s,this.clearSize()}clearSize(){this._width=void 0,this._height=void 0}get(e,t){return!this.matrix[t]||!this.matrix[t][e]?Nt:this.matrix[t][e]}width(){if(this._width)return this._width;const e=this.calculateWidth();return this._width=e,e}calculateWidth(){let e=0;for(let t=0;t<this.height();t++){const s=Object.keys(this.matrix[t]).reduce((i,n)=>(i=Number(i),n=Number(n),i>n?i:n),0);s>e&&(e=s)}return e+1}height(){if(this._height)return this._height;const e=this.calculateHeight();return this._height=e,e}calculateHeight(){return Object.keys(this.matrix).length}matches(e){for(let t=0;t<this.height();t++)for(let s=0;s<this.width();s++)if(!(this.get(s,t)===ut||e.get(s,t)===ut)&&this.get(s,t)!==e.get(s,t))return!1;return!0}compare(e){let t=new T([]);for(let s=0;s<this.height();s++)for(let i=0;i<this.width();i++)this.get(i,s)===e?t.add(i,s,0):this.get(i,s)>e?t.add(i,s,1):this.get(i,s)<e&&t.add(i,s,-1);return t}extract(e,t,s,i){let n=new T({});for(let o=0;o<s;o++)for(let h=0;h<i;h++)n.add(o,h,this.get(e+o,t+h));return n}toString(){let e="";for(let t=0;t<this.height();t++){for(let s=0;s<this.width();s++)e+="	"+this.get(s,t);e+=`
`}return e}}console.assert(new T([[0,0],[1,1],[2,2]]).width()==2,"Width should be 2");console.assert(new T([[0,0],[1,1],[2,2]]).height()==3,"Height should be 3");console.assert(new T([[-1,-1],[1,1],[2,2]]).get(1,2)===2,"an x y of 1, 2 should be 2");console.assert(new T([[-1,-1],[1,1],[2,2]]).get(4,5)===Nt,"an x y coordinate that does not exist should be empty");console.assert(new T([[5,5,5],[5,-1,4],[5,4,12]]).matches(new T([[5,5,5],[5,7,4],[5,4,-1]])),"values that are -1 should be skipped when matching");console.assert(new T([[5,5,5],[5,1,4],[5,4,12]]).matches(new T([[5,5,5],[5,7,4],[5,4,1]]))===!1,"If matrixes are different then they should not match");console.assert(new T([[5,5,5],[5,4,4],[5,4,3]]).matches(new T([[5,5,5],[5,4,4],[5,4,3]])),"Two matrixes that are the same shape and content should match");console.assert(new T([[5,5,5],[5,4,4],[5,4,3]]).compare(4).matches(new T([[1,1,1],[1,0,0],[1,0,-1]])),"Compare should show if a matrix value is less than or greater than the provided value");console.assert(new T([[5,5,5,5,5],[5,4,4,4,5],[5,4,3,4,5],[5,4,4,4,5],[5,5,5,5,5]]).extract(0,0,3,3).matches(new T([[5,5,5],[5,4,4],[5,4,3]])),"An extraction at the root should match");console.assert(new T([[0,1,2,3,4],[5,4,3,2,1],[7,8,9,12,11],[52,74,53,21,31],[59,64,93,32,41]]).extract(1,1,3,3).matches(new T([[4,3,2],[8,9,12],[74,53,21]])),"An extraction at the root should match");const us=[new T([[-1,-1,-1],[0,0,0],[0,1,0]]),new T([[-1,-1,-1],[1,0,1],[1,1,1]]),new T([[-1,-1,-1],[1,0,1],[1,1,0]]),new T([[-1,-1,-1],[1,0,1],[0,1,1]]),new T([[-1,-1,-1],[0,0,1],[0,1,1]]),new T([[-1,-1,-1],[1,0,0],[1,1,0]])],fs=[new T([[-1,-1,-1],[0,0,0],[1,1,1]])],ms=[new T([[-1,-1,-1],[0,0,0],[1,1,0]]),new T([[-1,-1,-1],[0,0,1],[1,1,1]])],gs=[new T([[-1,-1,-1],[-1,0,0],[0,1,1]]),new T([[-1,-1,-1],[1,0,0],[1,1,1]])],ws=[new T([[-1,-1,-1],[-1,0,0],[0,1,1]]),new T([[-1,-1,-1],[1,0,0],[1,1,1]])],Es=[new T([[-1,-1,-1],[-1,0,0],[0,0,1]])],Is=[new T([[-1,0,0],[-1,0,1],[-1,0,1]])],Ss=[new T([[-1,0,1],[-1,0,1],[-1,0,1]])],Ns=[new T([[-1,0,1],[-1,0,1],[-1,0,0]])],_s=[new T([[-1,0,1],[-1,0,0],[-1,-1,-1]])],ys=[new T([[-1,1,1],[-1,0,1],[-1,-1,-1]])],Os=[new T([[0,1,1],[0,0,0],[-1,-1,-1]])],Ps=[new T([[1,1,1],[0,0,0],[-1,-1,-1]])],vs=[new T([[1,1,0],[0,0,0],[-1,-1,-1]])],xs=[new T([[1,0,-1],[0,0,-1],[-1,-1,-1]])],Ws=[new T([[1,1,-1],[1,0,-1],[-1,-1,-1]])],Rs=[new T([[1,0,-1],[1,0,-1],[0,0,-1]])],Ls=[new T([[1,0,-1],[1,0,-1],[1,0,-1]])],Cs=[new T([[0,0,-1],[1,0,-1],[1,0,-1]])],Us=[new T([[-1,-1,-1],[0,0,-1],[1,0,-1]])],As=[new T([[-1,-1,-1],[1,0,-1],[1,1,-1]])],bs=[new T([[1,1,1],[1,1,-1],[-1,-1,-1]])],Fs=[new T([[0,1,-1],[1,1,-1],[-1,-1,-1]])],Hs=[new T([[0,0,-1],[-1,1,-1],[-1,-1,-1]])],Ds=[new T([[0,0,-1],[0,1,-1],[-1,-1,-1]])],Xs=[new T([[0,1,-1],[0,1,-1],[-1,-1,-1]])],g={};g[k]=us;g[B]=ms;g[R]=fs;g[G]=gs;g[Ke]=ws;g[Pe]=Es;g[fe]=Is;g[Ve]=Ss;g[ze]=Ns;g[je]=_s;g[Ye]=ys;g[Je]=Os;g[qe]=Ps;g[$e]=vs;g[Qe]=xs;g[Ze]=Ws;g[et]=Rs;g[tt]=Ls;g[me]=Cs;g[ve]=Us;g[st]=As;g[v]=bs;g[U]=Ds;g[A]=Xs;g[L]=Fs;g[C]=Hs;class Y{static getOrientation(e,t,s){return new Y().findOrientations(e,t,s)[0]}static getOrientations(e,t,s){return new Y().findOrientations(e,t,s)}findOrientations(e,t,s){return ps.reduce((i,n)=>(this.matchMatrixes(e,t,s,g[n])&&i.push(n),i),[])}matchMatrixes(e,t,s,i){const n=s.extract(e-1,t-1,3,3).compare(0);for(let o=0;o<i.length;o++)if(i[o].matches(n))return!0;return!1}}const z="BRICK",J="YELLOW_TILE",q="BLUE_TILE",$="GRAY_PATTERN",Q="HERRINGBONE",Z="CARPET_PATTERN",ee="CARPET_HORIZONTAL",te="CARPET_VERTICAL",se="CARPET_DUNNO",ft=[z,J,q,$,Q,Z,ee,te,se],l={};l[z]={};l[z][v]=114;l[z][L]=98;l[z][C]=97;l[z][U]=96;l[z][A]=113;l[J]={};l[J][v]=148;l[J][L]=132;l[J][C]=131;l[J][U]=130;l[J][A]=147;l[q]={};l[q][v]=182;l[q][L]=166;l[q][C]=165;l[q][U]=164;l[q][A]=181;l[$]={};l[$][v]=216;l[$][L]=200;l[$][C]=199;l[$][U]=198;l[$][A]=215;l[Q]={};l[Q][v]=250;l[Q][L]=234;l[Q][C]=233;l[Q][U]=232;l[Q][A]=249;l[Z]={};l[Z][v]=117;l[Z][L]=101;l[Z][C]=100;l[Z][U]=99;l[Z][A]=116;l[ee]={};l[ee][v]=151;l[ee][L]=135;l[ee][C]=134;l[ee][U]=133;l[ee][A]=150;l[te]={};l[te][v]=185;l[te][L]=169;l[te][C]=168;l[te][U]=167;l[te][A]=184;l[se]={};l[se][v]=219;l[se][L]=203;l[se][C]=202;l[se][U]=201;l[se][A]=218;class Ms extends _{constructor(e,t,s=z,i=v){super({position:new r(e,t)}),this.drawLayer="FLOOR";const n=new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:l[s][i]});this.addChild(n)}}class it{static generate(e){let{floorPlan:t,seed:s,style:i}=e;return new it().get(t,s,i)}get(e,t,s){!s&&t&&(s=this.seedStyle(t)),console.log(s);const i=[];for(let n=0;n<e.width();n++)for(let o=0;o<e.height();o++)if(e.get(n,o)>0){let h=Y.getOrientation(n,o,e);i.push(new Ms(d(n),d(o),s,h))}return i}seedStyle(e){return ft[Math.floor(ft.length*e())]}}const ie="RED_PATTERN",he="YELLOW_PATTERN",de="BLUE_PATTERN",ce="LIGHT_WOOD",le="DARK_WOOD",Te="OFFICE_GREY",pe="OFFICE_BROWN",mt=[ie,he,de,ce,le,Te,pe],m={};m[ie]={};m[ie][G]={TopWall:85,BottomWall:102};m[ie][R]={TopWall:86,BottomWall:103};m[ie][B]={TopWall:87,BottomWall:104};m[ie][k]={TopWall:88,BottomWall:105};m[he]={};m[he][G]={TopWall:119,BottomWall:136};m[he][R]={TopWall:120,BottomWall:137};m[he][B]={TopWall:121,BottomWall:138};m[he][k]={TopWall:122,BottomWall:139};m[de]={};m[de][G]={TopWall:153,BottomWall:170};m[de][R]={TopWall:154,BottomWall:171};m[de][B]={TopWall:155,BottomWall:172};m[de][k]={TopWall:156,BottomWall:173};m[ce]={};m[ce][G]={TopWall:187,BottomWall:204};m[ce][R]={TopWall:188,BottomWall:205};m[ce][B]={TopWall:189,BottomWall:206};m[ce][k]={TopWall:190,BottomWall:207};m[le]={};m[le][G]={TopWall:221,BottomWall:238};m[le][R]={TopWall:222,BottomWall:239};m[le][B]={TopWall:223,BottomWall:240};m[le][k]={TopWall:224,BottomWall:241};m[Te]={};m[Te][G]={TopWall:289,BottomWall:306};m[Te][R]={TopWall:290,BottomWall:307};m[Te][B]={TopWall:291,BottomWall:308};m[Te][k]={TopWall:292,BottomWall:309};m[pe]={};m[pe][G]={TopWall:323,BottomWall:340};m[pe][R]={TopWall:324,BottomWall:341};m[pe][B]={TopWall:325,BottomWall:342};m[pe][k]={TopWall:326,BottomWall:343};class ks extends _{constructor(e,t,s=R,i=ie){super({position:new r(e,t)});const n=new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:m[i][s].TopWall,position:new r(0,-16)});this.addChild(n);const o=new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:m[i][s].BottomWall});this.addChild(o)}}class nt{static generate(e){let{floorPlan:t,seed:s,style:i}=e;return new nt().get(t,s,i)}get(e,t,s){!s&&t&&(s=this.seedStyle(t));const i=[];for(let n=0;n<e.width();n++)for(let o=0;o<e.height();o++){if(!(e.get(n,o+1)>0&&e.get(n,o)==0))continue;let h=Y.getOrientation(n,o,e);h!==void 0&&(e.extract(n-1,o-1,3,3).compare(0),i.push(new ks(d(n),d(o),h,s)))}return i}seedStyle(e){return mt[Math.floor(mt.length*e())]}}const E={};E[Ke]=7;E[Pe]=24;E[fe]=28;E[Ve]=45;E[ze]=45;E[je]=62;E[Ye]=39;E[Je]=63;E[qe]=63;E[$e]=63;E[Qe]=64;E[Ze]=40;E[et]=47;E[tt]=47;E[me]=30;E[ve]=29;E[st]=29;class Bs extends _{constructor(e,t,s=R){super({position:new r(e,t)}),s===Pe?this.addMidTopTrim(fe):s===ve?this.addMidTopTrim(me):s===fe||s===me?this.addTopTrim(s):this.addTrim(s)}addMidTopTrim(e){this.addChild(new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:E[e],position:new r(0,d(-1))})),this.addChild(new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:E[e.replace("_TOP","")]}))}addTopTrim(e){this.addChild(new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:E[e],position:new r(0,d(-2))})),this.addChild(new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:E[e.replace("_TOP","")],position:new r(0,d(-1))})),this.addChild(new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:E[e.replace("_TOP","")]}))}addTrim(e){this.addChild(new f({resource:u.images.shopFloor,hFrames:17,vFrames:23,frame:E[e]}))}}class ot{static generate(e){let{floorPlan:t}=e;return new ot().get(t)}get(e){const t=[];for(let i=-1;i<e.width()+1;i++)for(let n=-1;n<e.height()+1;n++){if(e.get(i,n)!=0)continue;let o=Y.getOrientations(i,n,e);if(o!==void 0)for(var s=0;s<o.length;s++)t.push(new Bs(d(i),d(n),o[s]))}return t}}const rt="BLUE_DIAGONAL",_t="BLUE_STRIPE",yt="GOLD_STRIPE",Ot="PLAIN",Pt="HONEY_COVERED",vt="GREEN_DIAGONAL",Gs=[rt,_t,yt,Ot,Pt,vt],ne={};ne[rt]=0;ne[_t]=1;ne[yt]=2;ne[Ot]=3;ne[Pt]=4;ne[vt]=5;class Ks extends _{constructor(e,t,s=rt,i=void 0){super({position:new r(e,t)}),i!==void 0&&(s=Gs[Math.floor(i()*6)],console.log(s)),this.addChild(new f({resource:u.images.shadow,position:new r(-8,-21),frameSize:new r(32,32)})),this.addChild(new f({resource:u.images.vase,position:new r(0,-5),hFrames:1,vFrames:6,frame:ne[s]}))}}const at="MODERN",xt="EVIL_PURPLE",Wt="EVIL_BLACK",Rt="SPLATTER",Lt="MOUNTAIN",Ct="FIRE",Vs=[at,xt,Wt,Rt,Lt,Ct],oe={};oe[at]=0;oe[xt]=1;oe[Wt]=2;oe[Rt]=3;oe[Lt]=4;oe[Ct]=5;class zs extends _{constructor(e,t,s=at,i=void 0){super({position:new r(e,t)}),i!==void 0&&(s=Vs[Math.floor(i()*6)]),this.addChild(new f({resource:u.images.picture,position:new r(0,-10),hFrames:1,vFrames:6,frame:oe[s]}))}}const ht="NEWS",Ut="COOKING",At="NATURE",bt="ALIENS",Ft="OFF",js=[ht,Ut,At,bt,Ft],ue={};ue[ht]=0;ue[Ut]=1;ue[At]=2;ue[bt]=3;ue[Ft]=4;class Ys extends _{constructor(e,t,s=ht,i=void 0){super({position:new r(e,t)}),i!==void 0&&(s=js[Math.floor(i()*5)]),this.addChild(new f({resource:u.images.television,frameSize:new r(32,16),position:new r(-16,-10),hFrames:1,vFrames:6,frame:ue[s]}))}}const Js=5,I=new Map,xe=["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","0123456789 __",".!-,?'|⬤▶"].join("");I.set("c",4);I.set("f",4);I.set("i",2);I.set("j",4);I.set("l",3);I.set("n",4);I.set("r",4);I.set("t",4);I.set("u",4);I.set("v",4);I.set("x",4);I.set("y",4);I.set("z",4);I.set("E",4);I.set("F",4);I.set("M",7);I.set("W",7);I.set(" ",3);I.set("'",2);I.set("!",1);I.set("|",1);const dt=a=>I.get(a)??Js,Ht=new Map;xe.split("").forEach((a,e)=>{Ht.set(a,e)});const ge=a=>Ht.get(a)??0,P=class P{constructor(e={}){this.width=e.width??P.WIDTH,this.height=e.height??P.HEIGHT,this.maxSteps=e.maxSteps??P.MAX_STEPS,this.seed=e.seed??Math.seed(P.SEED),this.stepSize=e.stepSize??P.STEP_SIZE,this.randomGenerator=Math.seed(e.seed());let t=Math.round(this.random()*this.width),s=Math.round(this.random()*this.height);const i=new r(t,s);this.startingPosition=e.startingPosition??i}random(){return this.randomGenerator()}};y(P,"WIDTH",100),y(P,"HEIGHT",100),y(P,"MAX_STEPS",1e3),y(P,"STEP_SIZE",3),y(P,"SEED",9);let Me=P;class ct{static getFloorPlan(e){return new ct().walkDrunk(e)}walkDrunk(e){let t=this.generateMatrix(e),s=0,i=e.startingPosition.duplicate();for(;s<e.maxSteps;)i.x<e.stepSize-2&&(i.x=1),i.x>=e.width-e.stepSize&&(i.x=e.width-e.stepSize),i.y<e.stepSize-2&&(i.y=1),i.y>=e.height-e.stepSize&&(i.y=e.height-e.stepSize),t=this.createStep(i,e,t),i=this.randomStep(i,e),s++;return new T(t)}createStep(e,t,s){for(let i=0;i<t.stepSize;i++)for(let n=0;n<t.stepSize;n++)s[e.x+i][e.y+n]+=1;return s}randomStep(e,t){const s=[K,V,M,D],i=s[Math.round(t.random()*s.length)];return e.toStepNeighbor(i)}generateMatrix(e){const t={};for(let s=0;s<e.width;s++){t[s]=[];for(let i=0;i<e.height;i++)t[s][i]=0}return t}}class We extends Ne{constructor(e={}){super();try{this.params=e,this.background=new f({resource:u.images.shopBackground,frameSize:new r(320,180)}),this.gameObjects=[],this.floors=[],this.wallSprites=[],e.seedNumber!==void 0&&(e.seed=Math.seed(e.seedNumber)),this.seed=e.seed??Math.seed(Math.random()),e.seed=this.seed;const t=this.buildFloorPlan(e);this.floorPlan=t,this.walls=new Set,console.log("START this.addFloorSprites"),this.addFloorSprites(t,e),console.log("END this.addFloorSprites"),(e.showNextLevel===void 0||e.showNextLevel===!0)&&this.addNextLevelExit();const s=e.heroPosition??this.findHighestPosition(t);this.caveExitPosition=s.duplicate(),this.caveExitPosition.x+=d(1),this.addGameObject(new X(this.caveExitPosition.x,this.caveExitPosition.y));const i=new Oe(s.x,s.y);this.addGameObject(i),console.log("START this.addTrimSprites"),this.addTrimSprites(t,e),console.log("END this.addTrimSprites"),console.log("START this.addWallSprites"),this.addWallSprites(t,e),console.log("END this.addWallSprites"),console.log("START this.addVases"),this.addVases(t,e),console.log("END this.addVases"),console.log("START this.addPictures"),this.addPictures(e),console.log("END this.addPictures"),console.log("START this.addTelevisions"),this.addTelevisions(e),console.log("END this.addTelevisions"),console.log("START this.addBookshelves"),this.addBookshelves(e),console.log("END this.addBookshelves"),console.log("START this.getWalls"),this.walls=this.getWalls(this.walls,t),console.log("END this.getWalls")}catch(t){console.error(t)}}addNextLevelExit(){this.drunkWalkExitPosition=this.findFirstPosition(this.floorPlan),this.addGameObject(new X(this.drunkWalkExitPosition.x,this.drunkWalkExitPosition.y))}addGameObject(e){this.gameObjects.push(e),this.addChild(e)}addFloor(e){this.floors.push(e),this.addChild(e)}addWall(e){this.wallSprites.push(e),this.addChild(e)}findRandomSpot(e,t,s,i=d(1)){const n=this.findFirstPosition(this.floorPlan);return t=[...t,{position:n}],this.findRandomWallSpot(e,t,s,i)}findRandomWallSpot(e,t,s,i=d(1)){let n=new r(0,0),o=Math.floor(e()*t.length),h=o-1;for(var p=o;p%t.length!=h;p++){let w=p%t.length;if(this.isPositionFree(t[w],s,t[w].position.y,w,i))return t[w].position}return n}isPositionFree(e,t,s,i,n){for(;n>0&&(e==null?void 0:e.position.y)===s&&!this.atGameObject(e,t);){n-=d(1),i++;if(n===0)return!0}return console.log(s,i,n),!1}atGameObject(e,t){for(var s=t.length-1;s>=0;s--)if(t[s].position.matches(e.position))return!0;return!1}findFirstPosition(e){for(let t=0;t<e.width();t++)for(let s=0;s<e.height();s++)if(e.get(t,s)>1)return new r(d(t),d(s));return new r(0,0)}findHighestPosition(e){let t=new r(0,0);for(let s=0;s<e.width();s++)for(let i=0;i<e.height();i++)e.get(s,i)>e.get(t.x,t.y)&&(t=new r(s,i));return new r(d(t.x),d(t.y))}getWalls(e,t){for(let s=-1;s<=t.width();s++)for(let i=-1;i<=t.height();i++)t.get(s,i)==0&&e.add(`${d(s)}, ${d(i)}`);return e}buildFloorPlan(e){const t=new Me(e);return ct.getFloorPlan(t)}addFloorSprites(e,t){const s=it.generate({floorPlan:e,seed:t.seed});for(var i=s.length-1;i>=0;i--)this.addFloor(s[i])}addWallSprites(e,t){const s=nt.generate({floorPlan:e,seed:t.seed});for(var i=s.length-1;i>=0;i--)this.addWall(s[i])}addTrimSprites(e){const t=ot.generate({floorPlan:e});for(var s=t.length-1;s>=0;s--)this.addChild(t[s])}addVases(e,t){const s=this.findRandomSpot(this.seed,this.floors,this.gameObjects);this.addGameObject(new Ks(s.x,s.y,void 0,t.seed)),this.walls.add(`${s.x}, ${s.y}`)}addPictures(e){const t=this.findRandomWallSpot(this.seed,this.wallSprites,this.gameObjects);console.log(t),this.addGameObject(new zs(t.x,t.y,void 0,e.seed))}addTelevisions(e){const t=this.findRandomWallSpot(this.seed,this.wallSprites,this.gameObjects,d(2));console.log(t),this.addGameObject(new Ys(t.x,t.y,void 0,e.seed))}addBookshelves(e){}getOrientation(e,t,s){return Y.getOrientation(e,t,s)}ready(){c.on("HERO_EXIT",this,e=>{e.position.matches(this.caveExitPosition)&&c.emit("CHANGE_LEVEL",this.getHome()),e.position.matches(this.drunkWalkExitPosition)&&c.emit("CHANGE_LEVEL",this.getNextLevel())})}getHome(){return new ke({heroPosition:new r(d(4),d(4))})}getNextLevel(){return new We({seed:Math.seed(Math.random())})}}const qs=new r(d(3),d(3)),Le=new r(d(3),d(5)),Ce=new r(d(3),d(4));class ke extends Ne{constructor(e={}){super(),this.params=e,this.background=new f({resource:u.images.cave,frameSize:new r(320,180)});const t=new f({resource:u.images.caveGround,frameSize:new r(320,180)});this.addChild(t),this.addChild(new X(Le.x,Le.y)),this.addChild(new X(Ce.x,Ce.y));const s=e.heroPosition??qs,i=new Oe(s.x,s.y);this.addChild(i);const n=new Ge(d(7),d(5));this.addChild(n);const o=new pt(d(5),d(5),{content:[{string:"I just can't stand that guy",requires:[Tt],bypass:[Re],addsFlag:Re},{string:"He's just the worst!",requires:[Re]},{string:"Grumble grumble. Another day at work.",requires:[]}],portraitFrame:1});this.addChild(o);const h=new pt(d(8),d(5),{content:[{string:"What a wonderful day at work in the cave!",addsFlag:Tt}],portraitFrame:0});this.addChild(h),this.walls=new Set}ready(){c.on("HERO_EXIT",this,e=>{e.position.matches(Le)&&c.emit("CHANGE_LEVEL",new ae({heroPosition:new r(d(7),d(3))})),e.position.matches(Ce)&&c.emit("CHANGE_LEVEL",new We({seed:Math.seed(Math.random()),maxSteps:10}))})}}const $s=new r(d(3),d(3));class gt extends Ne{constructor(e={}){super(),this.params=e,this.background=new f({resource:u.images.shopBackground,frameSize:new r(320,180)}),this.buildFloor();const t=new X(d(3),d(2));this.addChild(t);const s=e.heroPosition??$s,i=new Oe(s.x,s.y);this.addChild(i),this.walls=new Set}getCharacterSprite(e,t=[]){return new f({resource:u.images.fontWhite,hFrames:13,vFrames:6,frame:ge(e),animations:t})}generateWords(e){return e.split(" ").map(t=>{let s=0;const i=t.split("").map(n=>{const o=this.getCharacterSprite(n),h=dt(n);return s+=h,{width:h,sprite:o}});return{wordWidth:s,chars:i}})}drawWord(e,t,s,i,n,o){return t+this.LINE_WIDTH_MAX-s<o.wordWidth&&(i+=this.LINE_VERTICAL_HEIGHT,s=t+this.PADDING_LEFT),o.chars.forEach(p=>{const w=this.drawCharacter(e,s,i,n,p);s=w.cursorX,i=w.cursorY,n=w.currentShowingIndex}),s+=3,{cursorX:s,cursorY:i,currentShowingIndex:n}}drawCharacter(e,t,s,i,n){const{sprite:o,width:h}=n,p=t-5;return o.draw(e,p,s),t+=h,t+=1,i+=1,{cursorX:t,cursorY:s,currentShowingIndex:i}}buildFloor(){let e=0;for(let t=0;t<this.params.sprite.vFrames;t++)for(let s=0;s<this.params.sprite.hFrames;s++){const i=new f({resource:this.params.sprite.resource,hFrames:this.params.sprite.hFrames,vFrames:this.params.sprite.vFrames,frame:e,position:new r(d(s),d(t))});e%(this.params.sprite.hFrames/4)===0&&this.addWordSprites(this.generateWords(e+""),d(s)-4,d(t)),this.addChild(i),e+=1}}addWordSprites(e,t,s){s+=3,e.forEach(i=>{i.chars.forEach(n=>{const o=n.sprite;o.position=new r(t,s),this.addChild(o),t+=n.width})})}ready(){c.on("HERO_EXIT",this,()=>{c.emit("CHANGE_LEVEL",this.params.nextLevel)})}}function Qs(a="|"){return{duration:500,frames:[{time:0,frame:ge(a)},{time:350,frame:ge(" ")}]}}function Zs(a){return new St({BLINKING:new F(Qs(a))})}class Dt extends _{constructor(t={}){super({position:new r(32,32)});y(this,"PADDING_LEFT",27);y(this,"PADDING_TOP",9);y(this,"LINE_WIDTH_MAX",240);y(this,"LINE_VERTICAL_HEIGHT",14);this.drawLayer="HUD",this.userInput="",this.content=t.string??"Default text",this.words=this.generateWords(this.content),this.background=new f({resource:u.images.userInputBox,frameSize:new r(256,128)}),this.portrait=new f({resource:u.images.portraits,hFrames:4,frame:t==null?void 0:t.portraitFrame}),this.showingIndex=0,this.finalIndex=this.words.reduce((s,i)=>s+i.chars.length,0),this.textSpeed=40,this.timeUntilNextShow=this.textSpeed,c.emit("START_TEXT_INPUT"),this.input=new Se(xe)}getCharacterSprite(t,s=[]){return new f({resource:u.images.fontWhite,hFrames:13,vFrames:6,frame:ge(t),animations:s})}generateWords(t){return t.split(" ").map(s=>{let i=0;const n=s.split("").map(o=>{const h=this.getCharacterSprite(o),p=dt(o);return i+=p,{width:p,sprite:h}});return{wordWidth:i,chars:n}})}step(t,s){this.handleDecisionInputs(),this.incrementSelfTypingText(t)}handleDecisionInputs(){if(this.input.getActionJustPressed("Enter")){if(this.showingIndex<this.finalIndex){this.showingIndex=this.finalIndex;return}c.emit("DECIDE_INPUT_TEXT",this.userInput)}this.input.getActionJustPressed("Escape")&&c.emit("CANCEL_INPUT_TEXT")}incrementSelfTypingText(t){this.timeUntilNextShow-=t,this.timeUntilNextShow<=0&&(this.showingIndex+=1,this.timeUntilNextShow=this.textSpeed)}drawImage(t,s,i){i-=20,t.beginPath(),t.fillStyle="rgba(0, 0, 0, 0.70)",t.rect(0,0,320,180),t.fill(),this.background.drawImage(t,s,i),this.portrait.drawImage(t,s+6,i+6);let n=s+this.PADDING_LEFT,o=i+this.PADDING_TOP,h=0;this.words.forEach(p=>{const w=this.drawWord(t,s,n,o,h,p);n=w.cursorX,o=w.cursorY,h=w.currentShowingIndex}),this.drawInput(t,s,i,n,o,h),this.drawFooter(t,s,i)}drawInput(t,s,i,n,o,h){}drawWord(t,s,i,n,o,h){return s+this.LINE_WIDTH_MAX-i<h.wordWidth&&(n+=this.LINE_VERTICAL_HEIGHT,i=s+this.PADDING_LEFT),h.chars.forEach(w=>{const O=this.drawCharacter(t,i,n,o,w);i=O.cursorX,n=O.cursorY,o=O.currentShowingIndex}),i+=3,{cursorX:i,cursorY:n,currentShowingIndex:o}}drawCharacter(t,s,i,n,o){if(n>this.showingIndex)return{cursorX:s,cursorY:i,currentShowingIndex:n};const{sprite:h,width:p}=o,w=s-5;return h.draw(t,w,i),s+=p,s+=1,n+=1,{cursorX:s,cursorY:i,currentShowingIndex:n}}drawFooter(t,s,i){let h=s+50,p=i+145;this.generateWords("ENTER - Decide ⬤ ESC - Cancel").forEach(O=>{O.chars.forEach(N=>{const{sprite:x,width:b}=N,W=h-5;x.draw(t,W,p),h+=b,h+=1}),h+=3})}}class ei extends Dt{constructor(e={}){super(e),this.cursor=this.getCharacterSprite("|",Zs("|")),this.cursor.animations.play("BLINKING"),this.addChild(this.cursor),this.stepToNextMove=100,this.lastMove=this.stepToNextMove,this.input=new Se(xe)}step(e,t){super.step(e,t),this.handleTyping(e)}handleTyping(e){if(this.input!==void 0&&(this.showingIndex<this.finalIndex?this.input.clearKeyboardText():this.userInput+=this.input.getKeyboardText()),this.lastMove-=e,!(this.lastMove>0)&&this.input.getActionJustPressed("Backspace")){const t=this.userInput.split("");t.splice(-1),this.userInput=t.join(""),this.lastMove=this.stepToNextMove}}drawInput(e,t,s,i,n,o){i=59,n+=16,this.generateWords(this.userInput).forEach(h=>{const p=this.drawWord(e,t,i,n,o,h);i=p.cursorX,n=p.cursorY,o=p.currentShowingIndex}),this.drawCursor(e,t,i,n)}drawCursor(e,t,s,i){const n={x:32,y:32},o=s-5-n.x;this.cursor.position=new r(o,i-n.y)}}class ti extends Dt{constructor(t={}){super(t);y(this,"MAX_VISIBLE_OPTIONS",7-1);this.options=t.options??["Default Option"],this.options=this.options.sort((s,i)=>s.toUpperCase().localeCompare(i.toUpperCase())),this.selectedOptionIndex=0,this.triangle=this.getCharacterSprite("▶"),this.stepToNextMove=100,this.lastMove=this.stepToNextMove,this.visibleStartIndex=this.getVisibleStartIndex(this.selectedOptionIndex),this.visibleEndIndex=this.getVisibleEndIndex(this.selectedOptionIndex),this.input=new Se(xe)}step(t,s){super.step(t,s),this.moveSelection(t),this.changeVisibleSelection(),this.updateUserInput(),this.addTriangle()}moveSelection(t){this.lastMove-=t,!(this.lastMove>0)&&(this.input.direction===M&&(this.selectedOptionIndex--,this.selectedOptionIndex<=0&&(this.selectedOptionIndex=0),this.lastMove=this.stepToNextMove),this.input.direction===D&&(this.selectedOptionIndex++,this.selectedOptionIndex>=this.options.length-1&&(this.selectedOptionIndex=this.options.length-1),this.lastMove=this.stepToNextMove))}changeVisibleSelection(){this.selectedOptionIndex>this.visibleEndIndex&&(this.visibleStartIndex=this.selectedOptionIndex-this.MAX_VISIBLE_OPTIONS,this.visibleEndIndex=this.selectedOptionIndex),this.selectedOptionIndex<this.visibleStartIndex&&(this.visibleStartIndex=this.selectedOptionIndex,this.visibleEndIndex=this.selectedOptionIndex+this.MAX_VISIBLE_OPTIONS)}updateUserInput(){this.userInput=this.options[this.selectedOptionIndex]}addTriangle(){this.showingIndex>=this.finalIndex&&!this.hasChild(this.triangle)&&this.addChild(this.triangle)}drawInput(t,s,i,n,o,h){this.cursorPosition=0,this.incrementY=14;const p={x:52,y:36};let w=0;this.options.forEach((O,N)=>{if(N<this.visibleStartIndex||N>this.visibleEndIndex)return;const x=this.shiftToVisibleIndex(N,this.visibleStartIndex);n=p.x+18,o=p.y+this.incrementY*x,N===this.selectedOptionIndex&&(w=o),this.generateWords(O).forEach(b=>{const W=this.drawWord(t,s,n,o,h,b);n=W.cursorX,o=W.cursorY,h=W.currentShowingIndex})}),h>=this.finalIndex&&this.drawTriangle(w)}drawTriangle(t){this.triangle.position=new r(25,t-32)}getVisibleStartIndex(t){return t}getVisibleEndIndex(t){return t+this.MAX_VISIBLE_OPTIONS}inRange(t,s){return Math.abs(t-s)<=this.MAX_VISIBLE_OPTIONS}shiftToVisibleIndex(t,s){return t-s}}class si extends Ge{constructor(e={}){super(e.position.x,e.position.y),this.params=e}onCollideWithHero(){try{c.emit(this.params.inputType,this.params.config);const e=c.on("SUBMIT_INPUT_TEXT",this,t=>{this.isCorrect(t)?this.answeredCorrectly(t):this.answeredIncorrectly(),console.log("Answered with ",t,"This was ",this.isCorrect(t)?"Correct":"Incorrect")})}catch(e){console.error(e)}}isCorrect(e){var t;return((t=this.params.answers)==null?void 0:t.indexOf(e))>-1}answeredCorrectly(e){this.destroy(),c.emit("HERO_PICKS_UP_ITEM",{image:u.images.rod,position:this.position});let t="";this.params.answers.length>1?t="Correct! You could've also answered with "+this.params.answers.map(s=>{if(s!==e)return`'${s}'`}).filter(s=>s!==void 0).join(", "):t=`Exactly! the correct answer was '${e}'`,c.emit("SHOW_TEXTBOX",{portraitFrame:this.portraitFrame,string:t,addFlags:null,onEnd:()=>{c.emit("HERO_ANSWERED_CORRECTLY",this.params.config.string)}})}answeredIncorrectly(){let e="";this.params.answers.length>1?e="Sorry. Try again. The correct answers could've been "+this.params.answers.map(t=>`'${t}'`).join(", "):e=`Hmm, no, try again. The correct answer was '${this.params.answers[0]}'`,c.emit("SHOW_TEXTBOX",{portraitFrame:this.portraitFrame,string:e,addFlags:null,onEnd:()=>{this.destroy(),c.emit("HERO_ANSWERED_INCORRECTLY",this.params.config.string)}})}}const Xt=[{config:{string:"What is the supreme law of the land?"},inputType:"TEXT_INPUT",answers:["the Constitution"]},{config:{string:"What does the Constitution do?"},inputType:"TEXT_INPUT",answers:["sets up the government","defines the government","protects basic rights of Americans"]},{config:{string:"The idea of self-government is in the first three words of the Constitution. What are these words?"},inputType:"TEXT_INPUT",answers:["We the People"]},{config:{string:"What is an amendment?"},inputType:"TEXT_INPUT",answers:["a change to the Constitution","a change","an addition to the Constitution","an addition"]},{config:{string:"What do we call the first ten amendments to the Constitution?"},inputType:"TEXT_INPUT",answers:["the Bill of Rights"]},{config:{string:"What is one right or freedom from the First Amendment?"},inputType:"TEXT_INPUT",answers:["speech","religion","assembly","press","petition the government"]},{config:{string:"How many amendments does the Constitution have?"},inputType:"TEXT_INPUT",answers:["twenty-seven","27"]},{config:{string:"What did the Declaration of Independence do?"},inputType:"TEXT_INPUT",answers:["announced our independence","announced our independence from Great Britain","declared our independence","declared our independence from Great Britain","said that the United States is free","said that the United States is free from Great Britain"]},{config:{string:"What are two rights in the Declaration of Independence?"},inputType:"TEXT_INPUT",answers:["life","liberty","pursuit of happiness"]},{config:{string:"What is freedom of religion?"},inputType:"TEXT_INPUT",answers:["You can practice any religion, or not practice a religion."]},{config:{string:"What is the economic system in the United States?"},inputType:"TEXT_INPUT",answers:["capitalist economy","market economy"]},{config:{string:"What is the rule of law?"},inputType:"TEXT_INPUT",answers:["Everyone must follow the law","Leaders must obey the law","Government must obey the law","No one is above the law"]}],Mt=[{config:{string:"Name one branch or part of the government."},inputType:"TEXT_INPUT",answers:["Congress","legislative","President","executive","the courts","judicial"]},{config:{string:"What stops one branch of government from becoming too powerful?"},inputType:"TEXT_INPUT",answers:["checks and balances","separation of powers"]},{config:{string:"Who is in charge of the executive branch?"},inputType:"TEXT_INPUT",answers:["the President"]},{config:{string:"Who makes federal laws?"},inputType:"TEXT_INPUT",answers:["Congress","Senate and House","Senate and House of Representatives","U.S. legislature","national legislature"]},{config:{string:"What are the two parts of the U.S. Congress?"},inputType:"TEXT_INPUT",answers:["the Senate and House","the Senate and House of Representatives"]},{config:{string:"How many U.S. Senators are there?"},inputType:"TEXT_INPUT",answers:["100","one hundred"]},{config:{string:"We elect a U.S. Senator for how many years?"},inputType:"TEXT_INPUT",answers:["6","six"]},{config:{string:"Who is one of your state's U.S. Senators now?"},inputType:"TEXT_INPUT",answers:["Ted Budd","Thom Tillis"]},{config:{string:"The House of Representatives has how many voting members?"},inputType:"TEXT_INPUT",answers:["435","four hundred thirty-five"]},{config:{string:"We elect a U.S. Representative for how many years?"},inputType:"TEXT_INPUT",answers:["two","2"]},{config:{string:"Name your U.S. Representative."},inputType:"TEXT_INPUT",answers:["Tim Moore"]},{config:{string:"Who does a U.S. Senator represent?"},inputType:"TEXT_INPUT",answers:["all people of the state"]},{config:{string:"Why do some states have more Representatives than other states?"},inputType:"TEXT_INPUT",answers:["because of the state's population"," the state's population","because they have more people","they have more people","because some states have more people","some states have more people","the state's population","they have more people","some states have more people"]},{config:{string:"We elect a President for how many years?"},inputType:"TEXT_INPUT",answers:["four","4"]},{config:{string:"In what month do we vote for President?"},inputType:"TEXT_INPUT",answers:["November"]},{config:{string:"What is the name of the President of the United States now?"},inputType:"TEXT_INPUT",answers:["Donald J. Trump","Donald John Trump","Donald Trump"]},{config:{string:"What is the name of the Vice President of the United States now?"},inputType:"TEXT_INPUT",answers:["J. D. Vance","JD Vance","James David Vance"]},{config:{string:"If the President can no longer serve, who becomes President?"},inputType:"TEXT_INPUT",answers:["the Vice President"]},{config:{string:"If both the President and the Vice President can no longer serve, who becomes President?"},inputType:"TEXT_INPUT",answers:["the Speaker of the House"]},{config:{string:"Who is the Commander in Chief of the military?"},inputType:"TEXT_INPUT",answers:["the President"]},{config:{string:"Who signs bills to become laws?"},inputType:"TEXT_INPUT",answers:["the President"]},{config:{string:"Who vetoes bills?"},inputType:"TEXT_INPUT",answers:["the President"]},{config:{string:"What does the President's Cabinet do?"},inputType:"TEXT_INPUT",answers:["advises the President"]},{config:{string:"What are two Cabinet-level positions?"},inputType:"TEXT_INPUT",answers:["Secretary of Agriculture","Secretary of Commerce","Secretary of Defense","Secretary of Education","Secretary of Energy","Secretary of Health and Human Services","Secretary of Homeland Security","Secretary of Housing and Urban Development","Secretary of the Interior","Secretary of Labor","Secretary of State","Secretary of Transportation","Secretary of the Treasury","Secretary of Veterans Affairs","Attorney General","Vice President"]},{config:{string:"What does the judicial branch do?"},inputType:"TEXT_INPUT",answers:["reviews laws","explains laws","resolves disputes (disagreements)","decides if a law goes against the Constitution"]},{config:{string:"What is the highest court in the United States?"},inputType:"TEXT_INPUT",answers:["the Supreme Court"]},{config:{string:"How many justices are on the Supreme Court?"},inputType:"TEXT_INPUT",answers:["9"]},{config:{string:"Who is the Chief Justice of the United States now?"},inputType:"TEXT_INPUT",answers:["John G. Roberts"]},{config:{string:"Under our Constitution, some powers belong to the federal government. What is one power of the federal government?"},inputType:"TEXT_INPUT",answers:["to print money","to declare war","to create an army","to make treaties"]},{config:{string:"Under our Constitution, some powers belong to the states. What is one power of the states?"},inputType:"TEXT_INPUT",answers:["provide schooling and education","provide protection (police)","provide safety (fire departments)","give a driver's license","approve zoning and land use"]},{config:{string:"Who is the Governor of your state now?"},inputType:"TEXT_INPUT",answers:["Josh Stein"]},{config:{string:"What is the capital of your state?"},inputType:"TEXT_INPUT",answers:["Raleigh"]},{config:{string:"What are the two major political parties in the United States?"},inputType:"TEXT_INPUT",answers:["Democratic and Republican"]},{config:{string:"What is the political party of the President now?"},inputType:"TEXT_INPUT",answers:["Republican"]},{config:{string:"What is the name of the Speaker of the House of Representatives now?"},inputType:"TEXT_INPUT",answers:["Mike Johnson"]}],kt=[{config:{string:"There are four amendments to the Constitution about who can vote. Describe one of them."},inputType:"TEXT_INPUT",answers:["Citizens eighteen and older can vote","Citizens 18 and older can vote","Citizens eighteen and older","Citizens 18 and older","You don't have to pay a poll tax to vote","You don't have to pay to vote","Any citizen can vote","Women and men can vote","A male citizen of any race","A male citizen of any race can vote"]},{config:{string:"What is one responsibility that is only for United States citizens?"},inputType:"TEXT_INPUT",answers:["serve on a jury","vote in a federal election"]},{config:{string:"Name one right only for United States citizens."},inputType:"TEXT_INPUT",answers:["vote in a federal election","run for federal office"]},{config:{string:"What are two rights of everyone living in the United States?"},inputType:"TEXT_INPUT",answers:["freedom of expression","freedom of speech","freedom of assembly","freedom to petition the government","freedom of religion","the right to bear arms"]},{config:{string:"What do we show loyalty to when we say the Pledge of Allegiance?"},inputType:"TEXT_INPUT",answers:["the United States","the flag"]},{config:{string:"What is one promise you make when you become a United States citizen?"},inputType:"TEXT_INPUT",answers:["give up loyalty to other countries","defend the Constitution and laws of the United States","obey the laws of the United States","serve in the U.S. military ","serve in the U.S. military if needed","serve the nation","serve do important work for the nation","serve the nation if needed","serve do important work for the nation if needed","be loyal to the United States"]},{config:{string:"How old do citizens have to be to vote for President?"},inputType:"TEXT_INPUT",answers:["eighteen and older","18 and older"]},{config:{string:"What are two ways that Americans can participate in their democracy?"},inputType:"TEXT_INPUT",answers:["vote","join a political party","help with a campaign","join a civic group","join a community group","give an elected official your opinion on an issue","call Senators and Representatives","publicly support or oppose an issue or policy","run for office","write to a newspaper"]},{config:{string:"When is the last day you can send in federal income tax forms?"},inputType:"TEXT_INPUT",answers:["April 15"]},{config:{string:"When must all men register for the Selective Service?"},inputType:"TEXT_INPUT",answers:["at age eighteen","at age 18","between eighteen and twenty-six","between 18 and 26"]}],Bt=[{config:{string:"What is one reason colonists came to America?"},inputType:"TEXT_INPUT",answers:["freedom","political liberty","religious freedom","economic opportunity","practice their religion","escape persecution"]},{config:{string:"Who lived in America before the Europeans arrived?"},inputType:"TEXT_INPUT",answers:["American Indians","Native Americans"]},{config:{string:"What group of people was taken to America and sold as slaves?"},inputType:"TEXT_INPUT",answers:["Africans","people from Africa"]},{config:{string:"Why did the colonists fight the British?"},inputType:"TEXT_INPUT",answers:["because of high taxes","taxation without representation","because the British army stayed in their houses (boarding, quartering)","boarding, quartering","because they didn't have self-government"]},{config:{string:"Who wrote the Declaration of Independence?"},inputType:"TEXT_INPUT",answers:["Jefferson","Thomas Jefferson"]},{config:{string:"When was the Declaration of Independence adopted?"},inputType:"TEXT_INPUT",answers:["July 4, 1776"]},{config:{string:"There were 13 original states. Name three."},inputType:"TEXT_INPUT",answers:["New Hampshire","Massachusetts","Rhode Island","Connecticut","New York","New Jersey","Pennsylvania","Delaware","Maryland","Virginia","North Carolina","South Carolina","Georgia"]},{config:{string:"What happened at the Constitutional Convention?"},inputType:"TEXT_INPUT",answers:["The Constitution was written.","The Founding Fathers wrote the Constitution."]},{config:{string:"When was the Constitution written?"},inputType:"TEXT_INPUT",answers:["1787"]},{config:{string:"The Federalist Papers supported the passage of the U.S. Constitution. Name one of the writers."},inputType:"TEXT_INPUT",answers:["James Madison","Madison","Alexander Hamilton","Hamilton","John Jay","Jay","Publius"]},{config:{string:"What is one thing Benjamin Franklin is famous for?"},inputType:"TEXT_INPUT",answers:["U.S. diplomat","oldest member of the Constitutional Convention","first Postmaster General of the United States","writer of Poor Richard's Almanac","started the first free libraries"]},{config:{string:"Who is the 'Father of Our Country'?"},inputType:"TEXT_INPUT",answers:["Washington","George Washington"]},{config:{string:"Who was the first President?"},inputType:"TEXT_INPUT",answers:["Washington","George Washington"]}],Gt=[{config:{string:"What territory did the United States buy from France in 1803?"},inputType:"TEXT_INPUT",answers:["the Louisiana Territory","Louisiana"]},{config:{string:"Name one war fought by the United States in the 1800s."},inputType:"TEXT_INPUT",answers:["War of 1812","Mexican-American War","Civil War","Spanish-American War"]},{config:{string:"Name the U.S. war between the North and the South."},inputType:"TEXT_INPUT",answers:["the Civil War","the War between the States"]},{config:{string:"Name one problem that led to the Civil War."},inputType:"TEXT_INPUT",answers:["slavery","economic reasons","states' rights"]},{config:{string:"What was one important thing that Abraham Lincoln did?"},inputType:"TEXT_INPUT",answers:["freed the slaves","Emancipation Proclamation","saved the Union","preserved the Union","led the United States during the Civil War"]},{config:{string:"What did the Emancipation Proclamation do?"},inputType:"TEXT_INPUT",answers:["freed the slaves","freed slaves in the Confederacy","freed slaves in the Confederate states","freed slaves in most Southern states"]},{config:{string:"What did Susan B. Anthony do?"},inputType:"TEXT_INPUT",answers:["fought for women's rights","fought for civil rights"]}],Kt=[{config:{string:"Name one war fought by the United States in the 1900s."},inputType:"TEXT_INPUT",answers:["World War I","World War II","Korean War","Vietnam War","Persian Gulf War","Gulf War"]},{config:{string:"Who was President during World War I?"},inputType:"TEXT_INPUT",answers:["Woodrow Wilson","Wilson"]},{config:{string:"Who was President during the Great Depression and World War II?"},inputType:"TEXT_INPUT",answers:["Franklin Roosevelt","Roosevelt"]},{config:{string:"Who did the United States fight in World War II?"},inputType:"TEXT_INPUT",answers:["Japan, Germany, and Italy"]},{config:{string:"Before he was President, Eisenhower was a general. What war was he in?"},inputType:"TEXT_INPUT",answers:["World War II"]},{config:{string:"During the Cold War, what was the main concern of the United States?"},inputType:"TEXT_INPUT",answers:["Communism"]},{config:{string:"What movement tried to end racial discrimination?"},inputType:"TEXT_INPUT",answers:["civil rights movement","civil rights"]},{config:{string:"What did Martin Luther King, Jr. do?"},inputType:"TEXT_INPUT",answers:["fought for civil rights","worked for equality for all Americans"]},{config:{string:"What major event happened on September 11, 2001, in the United States?"},inputType:"TEXT_INPUT",answers:["Terrorists attacked the United States."]},{config:{string:"Name one American Indian tribe in the United States."},inputType:"TEXT_INPUT",answers:["Cherokee","Navajo","Sioux","Chippewa","Choctaw","Pueblo","Apache","Iroquois","Creek","Blackfeet","Seminole","Cheyenne","Arawak","Shawnee","Mohegan","Huron","Oneida","Lakota","Crow","Teton","Hopi","Inuit"]}],Vt=[{config:{string:"Name one of the two longest rivers in the United States."},inputType:"TEXT_INPUT",answers:["Missouri River","Missouri","Mississippi River","Mississippi"]},{config:{string:"What ocean is on the West Coast of the United States?"},inputType:"TEXT_INPUT",answers:["Pacific Ocean","Pacific"]},{config:{string:"What ocean is on the East Coast of the United States?"},inputType:"TEXT_INPUT",answers:["Atlantic Ocean","Atlantic"]},{config:{string:"Name one U.S. territory."},inputType:"TEXT_INPUT",answers:["Puerto Rico","U.S. Virgin Islands","American Samoa","Northern Mariana Islands","Guam"]},{config:{string:"Name one state that borders Canada."},inputType:"TEXT_INPUT",answers:["Maine","New Hampshire","Vermont","New York","Pennsylvania","Ohio","Michigan","Minnesota","North Dakota","Montana","Idaho","Washington","Alaska"]},{config:{string:"Name one state that borders Mexico."},inputType:"TEXT_INPUT",answers:["California","Arizona","New Mexico","Texas"]},{config:{string:"What is the capital of the United States?"},inputType:"TEXT_INPUT",answers:["Washington, D.C."]},{config:{string:"Where is the Statue of Liberty?"},inputType:"TEXT_INPUT",answers:["New York Harbor","New York","Liberty Island"]}],zt=[{config:{string:"Why does the flag have 13 stripes?"},inputType:"TEXT_INPUT",answers:["because there were 13 original colonies","because the stripes represent the original colonies"]},{config:{string:"Why does the flag have 50 stars?"},inputType:"TEXT_INPUT",answers:["because there is one star for each state","because each star represents a state","because there are 50 states"]},{config:{string:"What is the name of the national anthem?"},inputType:"TEXT_INPUT",answers:["The Star-Spangled Banner"]}],jt=[{config:{string:"When do we celebrate Independence Day?"},inputType:"TEXT_INPUT",answers:["July 4"]},{config:{string:"Name two national U.S. holidays."},inputType:"TEXT_INPUT",answers:["New Year's Day","Martin Luther King, Jr. Day","Presidents' Day","Memorial Day","Independence Day","Labor Day","Columbus Day","Veterans Day","Thanksgiving","Christmas"]}],ii=[...Xt,...Mt,...kt,...Bt,...Gt,...Kt,...Vt,...zt,...jt];class S extends We{constructor(e={}){try{super({...e,width:100,height:100,maxSteps:5,showNextLevel:e.showNextLevel??!1}),this.questionsList=e.questions??[...ii],this.placeQuestionRod(this.findRandomSpot(this.seed,this.floors,this.gameObjects))}catch(t){console.error(t)}}placeQuestionRod(e){const t=this.getQuestion();t?this.addChild(new si({position:e,config:t.config,inputType:t.inputType,answers:t.answers})):this.addNextLevelExit()}ready(){super.ready(),c.on("HERO_ANSWERED_CORRECTLY",this,e=>{this.questionsList=this.questionsList.filter(t=>t.config.string!==e),this.placeQuestionRod(this.findRandomSpot(this.seed,this.floors,this.gameObjects))}),c.on("HERO_ANSWERED_INCORRECTLY",this,e=>{this.placeQuestionRod(this.findRandomSpot(this.seed,this.floors,this.gameObjects))})}getHome(){return typeof this.params.previousLevel=="function"?this.params.previousLevel():typeof this.params.previousLevel=="object"?this.params.previousLevel:new ae({heroPosition:new r(d(4),d(6))})}getNextLevel(){return typeof this.params.nextLevel=="function"?this.params.nextLevel():typeof this.params.nextLevel=="object"?this.params.nextLevel:new S({seed:this.params.seed})}getQuestion(){return this.questionsList[Math.floor(this.params.seed()*this.questionsList.length)]}}const ni=new r(d(6),d(5)),Ue=new r(d(6),d(3)),Ae=new r(d(11),d(2)),be=new r(d(14),d(3)),Fe=new r(d(3),d(6));class ae extends Ne{constructor(e={}){super(),this.params=e,this.background=new f({resource:u.images.sky,frameSize:new r(320,180)});const t=new f({resource:u.images.ground,frameSize:new r(320,180)});this.addChild(t);const s=new Ge(d(7),d(6));this.addChild(s),this.addChild(new X(Ue.x,Ue.y)),this.addChild(new X(Ae.x,Ae.y)),this.addChild(new X(be.x,be.y)),this.addChild(new X(Fe.x,Fe.y));const i=e.heroPosition??ni,n=new Oe(i.x,i.y);this.addChild(n),this.walls=new Set,this.walls.add("64, 48"),this.walls.add("64, 64"),this.walls.add("64, 80"),this.walls.add("80, 64"),this.walls.add("80, 80"),this.walls.add("112, 80"),this.walls.add("128, 80"),this.walls.add("144, 80"),this.walls.add("160, 80")}ready(){c.on("HERO_EXIT",this,e=>{if(e.position.matches(Ue)&&c.emit("CHANGE_LEVEL",new ke({heroPosition:new r(d(4),d(5))})),e.position.matches(Fe)){const t=Math.random(),s=Math.random(),i=Math.random(),n=Math.random(),o=Math.random(),h=Math.random(),p=Math.random(),w=Math.random(),O=Math.random(),N={seedNumber:t,showNextLevel:!0,questions:[...Xt]},x={seedNumber:s,showNextLevel:!0,questions:[...Mt]},b={seedNumber:i,showNextLevel:!0,questions:[...kt]},W={seedNumber:n,showNextLevel:!0,questions:[...Bt]},re={seedNumber:o,showNextLevel:!0,questions:[...Gt]},we={seedNumber:h,showNextLevel:!0,questions:[...Kt]},Ee={seedNumber:p,showNextLevel:!0,questions:[...Vt]},Ie={seedNumber:w,showNextLevel:!0,questions:[...zt]},lt={seedNumber:O,showNextLevel:!0,questions:[...jt],nextLevel:()=>new ke({heroPosition:new r(d(10),d(5))})};Ie.nextLevel=()=>new S(lt),Ee.nextLevel=()=>new S(Ie),we.nextLevel=()=>new S(Ee),re.nextLevel=()=>new S(we),W.nextLevel=()=>new S(re),b.nextLevel=()=>new S(W),x.nextLevel=()=>new S(b),N.nextLevel=()=>new S(x),lt.previousLevel=()=>new S(Ie),Ie.previousLevel=()=>new S(Ee),Ee.previousLevel=()=>new S(we),we.previousLevel=()=>new S(re),re.previousLevel=()=>new S(W),W.previousLevel=()=>new S(b),b.previousLevel=()=>new S(x),x.previousLevel=()=>new S(N),c.emit("CHANGE_LEVEL",new S(N))}e.position.matches(Ae)&&c.emit("CHANGE_LEVEL",new gt({sprite:new f({resource:u.images.shopFloor,hFrames:17,vFrames:23}),nextLevel:new ae({heroPosition:new r(d(12),d(2))})})),e.position.matches(be)&&c.emit("CHANGE_LEVEL",new gt({sprite:new f({resource:u.images.shopObjects,hFrames:16,vFrames:1424/16}),nextLevel:new ae({heroPosition:new r(d(15),d(2))})}))})}}class oi extends _{constructor(){super({position:new r(0,1)});y(this,"items",[]);this.drawLayer="HUD",this.nextId=0,this.items=[{id:-1,image:u.images.rod}],this.renderInventory()}ready(){c.on("HERO_PICKS_UP_ITEM",this,t=>{this.nextId+=1,this.items.push({id:this.nextId,image:t.image}),this.renderInventory()})}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,s)=>{const i=new f({resource:t.image,position:new r(s*12,0)});this.addChild(i)})}removeFromInventory(t){this.items=this.items.filter(s=>s.id!==t),this.renderInventory()}}class ri extends _{constructor(){super({}),c.on("HERO_POSITION",this,e=>{this.centerPositionOnTarget(e)}),c.on("CHANGE_LEVEL",this,e=>{this.centerPositionOnTarget(e.params.heroPosition)})}centerPositionOnTarget(e){e=e??new r(0,0);const t=8,s=320,i=180,n=-t+s/2,o=-t+i/2;this.position=new r(-e.x+n,-e.y+o)}}const ai=200,He=27,wt=6,Et=240,De=14;class It extends _{constructor(t={}){super({position:new r(32,112)});y(this,"cache",new Map);this.drawLayer="HUD",this.content=t.string??"Default text",this.words=this.content.split(" ").map(s=>{let i=0;const n=s.split("").map(o=>{const h=dt(o);return i+=h,{width:h,sprite:new f({resource:u.images.fontWhite,hFrames:13,vFrames:6,frame:ge(o)})}});return{wordWidth:i,chars:n,word:s}}),this.background=new f({resource:u.images.textBox,frameSize:new r(256,64)}),this.portrait=new f({resource:u.images.portraits,hFrames:4,frame:t==null?void 0:t.portraitFrame}),this.showingIndex=0,this.finalIndex=this.words.reduce((s,i)=>s+i.chars.length,0),this.currentFinalIndex=this.updateCurrentFinalIndex(),this.skipIndex=0,this.textSpeed=40,this.timeUntilNextShow=this.textSpeed,c.emit("START_TEXT_BOX")}step(t,s){try{const i=s.input;if(i!=null&&i.getActionJustPressed("Space")){if(this.showingIndex<this.currentFinalIndex){this.showingIndex=this.currentFinalIndex;return}if(this.showingIndex<this.finalIndex){this.updateCurrentFinalIndex();return}c.emit("END_TEXT_BOX")}this.timeUntilNextShow-=t,this.timeUntilNextShow<=0&&this.showingIndex<=this.currentFinalIndex&&(this.showingIndex+=1,this.timeUntilNextShow=this.textSpeed)}catch(i){console.error(i)}}updateCurrentFinalIndex(t){return this.currentFinalIndex===void 0&&(this.currentFinalIndex=0),t!==void 0&&(this.currentFinalIndex=t),this.currentFinalIndex<this.finalIndex&&(this.skipIndex=this.currentFinalIndex,this.currentFinalIndex+=ai,this.currentFinalIndex>=this.finalIndex&&(this.currentFinalIndex=this.finalIndex)),this.currentFinalIndex}drawImage(t,s,i){this.drawPosX=s,this.drawPosY=i,this.background.drawImage(t,s,i),this.portrait.drawImage(t,s+6,i+6),this.cursorX=s+He,this.cursorY=i+wt;const n=this.getWordsConfig(this.skipIndex,this.currentFinalIndex,this.cursorX,s,i);let o=n.startIndex;this.currentFinalIndex=n.endIndex,n.words.forEach(h=>{s+Et-this.cursorX<h.wordWidth&&(this.cursorY+=De,this.cursorX=s+He),h.chars.forEach(w=>{if(o>this.showingIndex)return;const{sprite:O,width:N}=w,x=this.cursorX-5;O.draw(t,x,this.cursorY),this.cursorX+=N,this.cursorX+=1,o+=1}),this.cursorX+=3})}getWordsConfig(t,s,i,n,o){let h=0,p=o+wt;if(this.cache.has(t))return this.cache.get(t);const O={words:this.words.map(N=>{if(n+Et-i<N.wordWidth&&(p+=De,i=n+He),!(h>=s)){if(p>=o+De*4){s=h;return}if(N.chars.forEach(b=>{if(h>=t-1){const{sprite:W,width:re}=b;i+=re,i+=1}h+=1}),h<=s&&h>=t)return i+=3,N}}).filter(N=>N!==void 0),startIndex:t,endIndex:h+1};return this.cache.set(t,O),O}}class hi extends _{constructor(){super({}),this.level=null,this.input=new Se,this.camera=new ri}ready(){const e=new oi;this.addChild(e),c.on("HERO_REQUESTS_ACTION",this,t=>{if(typeof t.getContent!="function")return;const s=t.getContent();if(!s)return;s.addFlags&&(console.log("Add FLAG",s.addFlags),Xe.add(s.addFlags));const i=new It({portraitFrame:s.portraitFrame,string:s.string});this.addChild(i);const n=c.on("END_TEXT_BOX",this,()=>{i.destroy(),c.off(n)})}),c.on("SHOW_TEXTBOX",this,t=>{t.addFlags&&(console.log("Add FLAG",t.addFlags),Xe.add(t.addFlags));const s=new It({portraitFrame:t.portraitFrame,string:t.string});this.addChild(s);const i=c.on("END_TEXT_BOX",this,()=>{s.destroy(),c.off(i),typeof t.onEnd=="function"&&t.onEnd()})}),c.on("CHANGE_LEVEL",this,t=>{this.setLevel(t)}),c.on("TEXT_INPUT",this,t=>{const s=new ei(t);this.addChild(s);const i=c.on("DECIDE_INPUT_TEXT",this,o=>{c.emit("SUBMIT_INPUT_TEXT",o),s.destroy(),c.off(i)}),n=c.on("CANCEL_INPUT_TEXT",this,()=>{s.destroy(),c.off(n)})}),c.on("SELECT_INPUT",this,t=>{const s=new ti(t);this.addChild(s);const i=c.on("DECIDE_INPUT_TEXT",this,o=>{c.emit("SUBMIT_INPUT_TEXT",o),s.destroy(),c.off(i)}),n=c.on("CANCEL_INPUT_TEXT",this,()=>{s.destroy(),c.off(n)})})}setLevel(e){this.level&&this.level.destroy(),this.level=e,this.addChild(this.level)}drawBackground(e){var t;(t=this.level)==null||t.background.drawImage(e,0,0)}drawObjects(e){this.children.forEach(t=>{t.drawLayer!=="HUD"&&t.draw(e,0,0)})}drawForeground(e){this.children.forEach(t=>{t.drawLayer==="HUD"&&t.draw(e,0,0)})}}Math.seed=function(a){return function(){return a=Math.sin(a)*1e4,a-Math.floor(a)}};const Be=document.querySelector("#game-canvas"),j=Be.getContext("2d"),H=new hi({position:new r(0,0)});H.setLevel(new ae);const di=()=>{j.clearRect(0,0,Be.windows,Be.height),H.drawBackground(j),j.save(),H.camera&&j.translate(H.camera.position.x,H.camera.position.y),H.drawObjects(j),j.restore(),H.drawForeground(j)},ci=a=>{var e;H.stepEntry(a,H),(e=H.input)==null||e.update()},li=new Qt(ci,di);li.start();
